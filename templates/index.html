<!-- HTML5 Doctype: Declares document type for browser to use modern HTML5 rendering mode. Functionality: Ensures consistent parsing across browsers. Issue: None. Opt: None needed. -->
<!DOCTYPE html>
<!-- HTML root element: Sets language for screen readers and search engines. Functionality: Improves accessibility (ARIA) and SEO. Issue: Hard-coded 'en'; dynamic if multi-lang. Opt: Add dir="ltr" for text direction. -->
<html lang="en">
<head>
    <!-- Meta charset: Specifies UTF-8 encoding for full unicode support. Functionality: Prevents garbled characters in international inputs (e.g., API keys). Issue: Default in modern browsers, but explicit good. Opt: None. -->
    <meta charset="UTF-8">
    <!-- Viewport meta: Enables responsive scaling on mobile. Functionality: Initial scale 1.0, width=device-width for fluid layout. Issue: Fixed; no user-scalable=no for accessibility. Opt: Add user-scalable=yes. -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Title: Sets page title in tab/bookmark. Functionality: User-friendly name for config UI. Issue: Static; could be dynamic. Opt: Add meta description for SEO if public. -->
    <title>LLM Proxy Configuration</title>
    <!-- CSS link: Loads style.css from static folder via Flask url_for for path resolution. Functionality: Applies neumorphic styling. Issue: If /static not served or auth applied, 404 or blocked. Opt: Inline critical CSS for performance, add preload. -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Model Discovery JavaScript -->
    <script src="{{ url_for('static', filename='js/model_discovery.js') }}" defer></script>
</head>
<body>
    <!-- Body: Main content wrapper. Functionality: Contains all UI elements. Issue: No role or lang repeat. Opt: Add onload for JS init. -->
    <div class="container" role="main" aria-label="LLM Proxy Dashboard and Configuration">  <!-- Add ARIA: role=main for screen readers, aria-label for description. -->
        <!-- Navigation: Tabs for Dashboard and Configuration. Functionality: Allows switching views. Issue: No JS for tab switching. Opt: Add JS to show/hide sections. -->
        <nav class="nav-tabs" role="navigation" aria-label="Main navigation">
            <button id="dashboard-tab" class="tab-btn active" onclick="showTab('dashboard')">Dashboard</button>
            <button id="config-tab" class="tab-btn" onclick="showTab('config')">Configuration</button>
        </nav>

        <!-- Dashboard Section -->
        <div id="dashboard-section" class="tab-content active">
            <h1>LLM Proxy Dashboard</h1>

            <!-- Providers Status -->
            <section class="dashboard-card neumorphic-card">
                <h2>Providers Status</h2>
                <div id="providers-status" class="status-list">
                    <p>Loading providers...</p>
                </div>
            </section>

            <!-- Recent Logs -->
            <section class="dashboard-card neumorphic-card">
                <h2>Recent Logs</h2>
                <div id="recent-logs" class="logs-list">
                    <p>Loading logs...</p>
                </div>
            </section>
        </div>

        <!-- Configuration Section -->
        <div id="config-section" class="tab-content">
            <h1>LLM Proxy Configuration</h1>

        <!-- Flash messages: Jinja block to display Flask flashed messages with categories (error/success). Functionality: User feedback from server validation/saves. Issue: No auto-dismiss; static display. Opt: Add JS for fade-out, ARIA live region for dynamic updates. -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages" role="alert" aria-live="polite">  <!-- Add ARIA: role=alert for screen reader announcement, aria-live for dynamic. -->
                {% for category, message in messages %}
                    <div class="flash {{ category }}" role="status">{{ message }}</div>  <!-- ARIA: role=status for non-interactive messages. -->
                {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <!-- Main form: Submits config data to server. Functionality: POST to save route with form data. Issue: No CSRF protection (vulnerable to attacks; use Flask-WTF). Action mismatch if route renamed. No client validation. Opt: Add CSRF token <input type="hidden" name="csrf_token" value="placeholder"> if WtfForms, inline JS for validation. -->
        <form action="{{ url_for('save_config') }}" method="post" role="form" aria-label="LLM Proxy configuration form">  <!-- Fix: Update action to save_config. Add ARIA: role=form, aria-label for screen readers. -->

            <details class="config-section" open>
                <summary>Server Settings</summary>
                <fieldset class="neumorphic-card">
                    <div class="form-group">
                        <label for="port" aria-describedby="port-help">Server Port <span aria-hidden="true">*</span></label>
                        <input type="number" id="port" name="port" value="{{ env_vars.get('PROXY_API_PORT', 8000) }}" class="neumorphic-input" aria-required="true" min="1" max="65535" required>
                        <small id="port-help" class="help-text">Port between 1 and 65535.</small>
                    </div>
                    <div class="form-group">
                        <label for="api_key_header" aria-describedby="header-help">API Key Header</label>
                        <input type="text" id="api_key_header" name="api_key_header" value="{{ env_vars.get('PROXY_API_API_KEY_HEADER', 'X-API-Key') }}" class="neumorphic-input" aria-describedby="header-help" pattern="[A-Za-z0-9_-]+" title="Alphanumeric, underscore, hyphen only.">
                        <small id="header-help" class="help-text">Header name for API key (e.g., X-API-Key).</small>
                    </div>
                </fieldset>
            </details>

            <details class="config-section">
                <summary>Security & API Keys</summary>
                <fieldset class="neumorphic-card">
                    <div class="form-group">
                        <label for="api_keys">API Keys</label>
                        <textarea id="api_keys" name="api_keys" class="neumorphic-textarea" rows="3" aria-describedby="api-keys-help">{{ config.get('settings', {}).get('api_keys', []) | join('\n') }}</textarea>
                        <small id="api-keys-help" class="help-text">One API key per line. These keys grant access to the proxy.</small>
                    </div>
                    <div class="form-group">
                        <label for="cors_origins">CORS Origins</label>
                        <textarea id="cors_origins" name="cors_origins" class="neumorphic-textarea" rows="2" aria-describedby="cors-help">{{ config.get('settings', {}).get('cors_origins', ['*']) | join('\n') }}</textarea>
                        <small id="cors-help" class="help-text">Allowed origins for CORS. Use '*' for all. One per line.</small>
                    </div>
                </fieldset>
            </details>

            <details class="config-section">
                <summary>Rate Limiting</summary>
                <fieldset class="neumorphic-card">
                    <div class="form-group">
                        <label for="rate_limit_rpm">Requests Per Minute</label>
                        <input type="number" id="rate_limit_rpm" name="rate_limit_rpm" value="{{ config.get('settings', {}).get('rate_limit_rpm', 1000) }}" class="neumorphic-input" min="1">
                        <small class="help-text">Global requests per minute limit.</small>
                    </div>
                    <div class="form-group">
                        <label for="rate_limit_window">Rate Limit Window (seconds)</label>
                        <input type="number" id="rate_limit_window" name="rate_limit_window" value="{{ config.get('settings', {}).get('rate_limit_window', 60) }}" class="neumorphic-input" min="1">
                        <small class="help-text">The time window for the rate limit.</small>
                    </div>
                </fieldset>
            </details>

            <details class="config-section">
                <summary>Caching (Model Discovery)</summary>
                <fieldset class="neumorphic-card">
                    <div class="form-group">
                        <label for="cache_enabled">
                            <input type="checkbox" id="cache_enabled" name="cache_enabled" value="true" {% if config.get('settings', {}).get('cache', {}).get('cache_enabled', true) %}checked{% endif %} class="neumorphic-input">
                            Enable Model Discovery Cache
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="cache_ttl">Cache TTL (seconds)</label>
                        <input type="number" id="cache_ttl" name="cache_ttl" value="{{ config.get('settings', {}).get('cache', {}).get('cache_ttl', 300) }}" class="neumorphic-input" min="60">
                        <small class="help-text">Time-to-live for cached model discovery results.</small>
                    </div>
                    <div class="form-group">
                        <label for="cache_persist">
                            <input type="checkbox" id="cache_persist" name="cache_persist" value="true" {% if config.get('settings', {}).get('cache', {}).get('cache_persist', false) %}checked{% endif %} class="neumorphic-input">
                            Enable Persistent Cache
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="cache_dir">Cache Directory</label>
                        <input type="text" id="cache_dir" name="cache_dir" value="{{ config.get('settings', {}).get('cache', {}).get('cache_dir', '') }}" class="neumorphic-input" placeholder="e.g., /var/cache/llm_proxy">
                        <small class="help-text">Directory for persistent cache (if enabled).</small>
                    </div>
                </fieldset>
            </details>

            <details class="config-section">
                <summary>Circuit Breaker</summary>
                <fieldset class="neumorphic-card">
                    <div class="form-group">
                        <label for="circuit_breaker_threshold">Failure Threshold</label>
                        <input type="number" id="circuit_breaker_threshold" name="circuit_breaker_threshold" value="{{ config.get('settings', {}).get('circuit_breaker_threshold', 5) }}" class="neumorphic-input" min="1">
                        <small class="help-text">Number of failures before the circuit opens.</small>
                    </div>
                    <div class="form-group">
                        <label for="circuit_breaker_timeout">Timeout (seconds)</label>
                        <input type="number" id="circuit_breaker_timeout" name="circuit_breaker_timeout" value="{{ config.get('settings', {}).get('circuit_breaker_timeout', 60) }}" class="neumorphic-input" min="1">
                        <small class="help-text">Time before trying to close the circuit.</small>
                    </div>
                </fieldset>
            </details>

            <details class="config-section">
                <summary>Context Condensation</summary>
                <fieldset class="neumorphic-card">
                    <div class="form-group">
                        <label for="condensation_cache_ttl">Cache TTL (seconds)</label>
                        <input type="number" id="condensation_cache_ttl" name="condensation_cache_ttl" value="{{ config.get('settings', {}).get('condensation', {}).get('cache_ttl', 3600) }}" class="neumorphic-input">
                    </div>
                    <div class="form-group">
                        <label for="condensation_cache_size">Cache Size</label>
                        <input type="number" id="condensation_cache_size" name="condensation_cache_size" value="{{ config.get('settings', {}).get('condensation', {}).get('cache_size', 1000) }}" class="neumorphic-input">
                    </div>
                    <div class="form-group">
                        <label for="truncation_threshold">Truncation Threshold</label>
                        <input type="number" id="truncation_threshold" name="truncation_threshold" value="{{ config.get('settings', {}).get('condensation', {}).get('truncation_threshold', 2000) }}" class="neumorphic-input">
                    </div>
                    <div class="form-group">
                        <label for="max_tokens_default">Default Max Tokens</label>
                        <input type="number" id="max_tokens_default" name="max_tokens_default" value="{{ config.get('settings', {}).get('condensation', {}).get('max_tokens_default', 512) }}" class="neumorphic-input">
                    </div>
                    <div class="form-group">
                        <label for="adaptive_factor">Adaptive Factor</label>
                        <input type="number" step="0.01" id="adaptive_factor" name="adaptive_factor" value="{{ config.get('settings', {}).get('condensation', {}).get('adaptive_factor', 0.5) }}" class="neumorphic-input">
                    </div>
                    <div class="form-group">
                        <label for="error_keywords">Error Keywords</label>
                        <textarea id="error_keywords" name="error_keywords" class="neumorphic-textarea" rows="2">{{ config.get('settings', {}).get('condensation', {}).get('error_keywords', []) | join(', ') }}</textarea>
                        <small class="help-text">Comma-separated keywords to detect long context errors.</small>
                    </div>
                     <div class="form-group">
                        <label for="fallback_strategies">Fallback Strategies</label>
                        <textarea id="fallback_strategies" name="fallback_strategies" class="neumorphic-textarea" rows="2">{{ config.get('settings', {}).get('condensation', {}).get('fallback_strategies', []) | join(', ') }}</textarea>
                        <small class="help-text">Comma-separated list of strategies (e.g., truncate, secondary_provider).</small>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="condensation_cache_persist" value="true" {% if config.get('settings', {}).get('condensation', {}).get('cache_persist', false) %}checked{% endif %} class="neumorphic-input">
                            Enable Persistent Cache
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="adaptive_enabled" value="true" {% if config.get('settings', {}).get('condensation', {}).get('adaptive_enabled', true) %}checked{% endif %} class="neumorphic-input">
                            Enable Adaptive Token Limit
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="dynamic_reload" value="true" {% if config.get('settings', {}).get('condensation', {}).get('dynamic_reload', true) %}checked{% endif %} class="neumorphic-input">
                            Enable Dynamic Reload
                        </label>
                    </div>
                </fieldset>
            </details>

            <details class="config-section" open>
                <summary>Providers</summary>
                <fieldset class="neumorphic-card">
                    <div id="provider-list" aria-labelledby="providers-legend">
                        {% for provider in config.get('providers', []) %}
                        <div class="provider-card neumorphic-card-inset" role="group" aria-labelledby="provider-{{ loop.index0 }}-name">
                            <div class="form-group">
                                <label id="provider-{{ loop.index0 }}-name" for="name-{{ loop.index0 }}">Name <span aria-hidden="true">*</span></label>
                                <input type="text" id="name-{{ loop.index0 }}" name="provider_name_{{ loop.index0 }}" value="{{ provider.name }}" class="neumorphic-input" aria-required="true" required>
                            </div>
                            <div class="form-group">
                                <label for="key-{{ loop.index0 }}">API Key</label>
                                <input type="password" id="key-{{ loop.index0 }}" name="api_key_value_{{ loop.index0 }}" value="" class="neumorphic-input" placeholder="Enter API Key" autocomplete="new-password">
                                <input type="hidden" name="api_key_env_{{ loop.index0 }}" value="{{ provider.api_key_env }}">
                            </div>
                            <div class="form-group">
                                <label for="enabled-{{ loop.index0 }}">
                                    <input type="checkbox" id="enabled-{{ loop.index0 }}" name="enabled_{{ loop.index0 }}" value="true" {% if provider.enabled|default(true) %}checked{% endif %} class="neumorphic-input">
                                    Enabled
                                </label>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="radio" name="forced_provider" value="{{ provider.name }}" {% if provider.forced|default(false) %}checked{% endif %} class="neumorphic-input">
                                    Force this provider
                                </label>
                            </div>
                            <div class="form-group">
                                <label for="models-{{ loop.index0 }}">Models</label>
                                <textarea id="models-{{ loop.index0 }}" name="models_{{ loop.index0 }}" class="neumorphic-textarea" rows="2">{{ provider.models | join(', ') }}</textarea>
                                <small class="help-text">Comma-separated list of models.</small>
                            </div>
                            <div class="form-group">
                                <label for="priority-{{ loop.index0 }}">Priority</label>
                                <input type="number" id="priority-{{ loop.index0 }}" name="priority_{{ loop.index0 }}" value="{{ provider.priority | default(100) }}" class="neumorphic-input" min="1">
                            </div>
                            <div class="form-group">
                                <label for="timeout-{{ loop.index0 }}">Timeout (s)</label>
                                <input type="number" id="timeout-{{ loop.index0 }}" name="timeout_{{ loop.index0 }}" value="{{ provider.timeout | default(30) }}" class="neumorphic-input" min="1">
                            </div>
                             <div class="form-group">
                                <label for="max_retries-{{ loop.index0 }}">Max Retries</label>
                                <input type="number" id="max_retries-{{ loop.index0 }}" name="max_retries_{{ loop.index0 }}" value="{{ provider.max_retries | default(3) }}" class="neumorphic-input" min="0">
                            </div>
                             <div class="form-group">
                                <label for="retry_delay-{{ loop.index0 }}">Retry Delay (s)</label>
                                <input type="number" step="0.1" id="retry_delay-{{ loop.index0 }}" name="retry_delay_{{ loop.index0 }}" value="{{ provider.retry_delay | default(1.0) }}" class="neumorphic-input" min="0.1">
                            </div>
                            <div class="form-group">
                                <label for="rate_limit-{{ loop.index0 }}">Rate Limit (RPM)</label>
                                <input type="number" id="rate_limit-{{ loop.index0 }}" name="rate_limit_{{ loop.index0 }}" value="{{ provider.rate_limit | default('') }}" class="neumorphic-input" placeholder="Optional" min="1">
                            </div>
                            <div class="form-group">
                                <label for="max_connections-{{ loop.index0 }}">Max Connections</label>
                                <input type="number" id="max_connections-{{ loop.index0 }}" name="max_connections_{{ loop.index0 }}" value="{{ provider.max_connections | default(1000) }}" class="neumorphic-input" min="1">
                            </div>
                            <div class="form-group">
                                <label for="max_keepalive_connections-{{ loop.index0 }}">Max Keepalive Connections</label>
                                <input type="number" id="max_keepalive_connections-{{ loop.index0 }}" name="max_keepalive_connections_{{ loop.index0 }}" value="{{ provider.max_keepalive_connections | default(100) }}" class="neumorphic-input" min="1">
                            </div>
                            <div class="form-group">
                                <label for="keepalive_expiry-{{ loop.index0 }}">Keepalive Expiry (s)</label>
                                <input type="number" step="0.1" id="keepalive_expiry-{{ loop.index0 }}" name="keepalive_expiry_{{ loop.index0 }}" value="{{ provider.keepalive_expiry | default(30.0) }}" class="neumorphic-input" min="1">
                            </div>
                            <div class="form-group">
                                <label for="custom_headers-{{ loop.index0 }}">Custom Headers (JSON)</label>
                                <textarea id="custom_headers-{{ loop.index0 }}" name="custom_headers_{{ loop.index0 }}" class="neumorphic-textarea" rows="2">{{ provider.custom_headers | tojson(indent=2) if provider.custom_headers else '{}' }}</textarea>
                            </div>
                            <!-- Hidden fields -->
                            <input type="hidden" name="type_{{ loop.index0 }}" value="{{ provider.type }}">
                            <input type="hidden" name="base_url_{{ loop.index0 }}" value="{{ provider.base_url|default('') }}">
                        </div>
                        {% endfor %}
                    </div>
                </fieldset>
            </details>

            <!-- Form actions: Container for buttons. Functionality: Centers submit. Issue: No cancel/reset. Opt: Add reset button. -->
            <div class="form-actions">
                <button type="submit" class="neumorphic-btn" aria-label="Save configuration changes">Save Changes</button>  <!-- ARIA: aria-label for description. -->
            </div>
        </form>
        </div>  <!-- End config-section -->
    </div>
    <!-- Inline JS for tab switching, AJAX, and validation. -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Tab switching
            window.showTab = function(tabName) {
                // Hide all tabs
                document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                // Show selected tab
                document.getElementById(tabName + '-section').classList.add('active');
                document.getElementById(tabName + '-tab').classList.add('active');
                // Load dashboard data if switching to dashboard
                if (tabName === 'dashboard') {
                    loadDashboardData();
                }
            };

            // AJAX function
            function fetchData(url, callback) {
                fetch(url)
                    .then(response => response.json())
                    .then(data => callback(data))
                    .catch(error => console.error('Error fetching data:', error));
            }

            // Load dashboard data
            function loadDashboardData() {
                // Load providers
                fetchData('/api/dashboard/providers', function(data) {
                    const container = document.getElementById('providers-status');
                    if (data.providers && data.providers.length > 0) {
                        container.innerHTML = data.providers.map(provider => `
                            <div class="provider-item ${provider.status}" data-forced="${provider.forced}">
                                <strong>${provider.name}</strong> (${provider.type}) - ${provider.status}
                                ${provider.forced ? '<span style="color: #4a90e2;"> [FORCED]</span>' : ''}
                                <br>Models: ${provider.models.join(', ')}
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<p>No providers configured.</p>';
                    }
                });

                // Load logs
                fetchData('/api/dashboard/logs', function(data) {
                    const container = document.getElementById('recent-logs');
                    if (data.logs && data.logs.length > 0) {
                        container.innerHTML = data.logs.map(log => `
                            <div class="log-item ${log.level.toLowerCase()}">
                                <span class="log-time">${new Date(log.timestamp).toLocaleString()}</span>
                                <span class="log-level">${log.level}</span>
                                <span class="log-message">${log.message}</span>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<p>No recent logs.</p>';
                    }
                });
            }

            // Load dashboard on page load
            loadDashboardData();

            // Form validation (existing)
            const form = document.querySelector('form[role="form"]');
            if (form) {
                form.addEventListener('submit', function(e) {
                    let valid = true;
                    // Validate port
                    const port = document.getElementById('port');
                    if (port && port.value && (isNaN(port.value) || port.value < 1 || port.value > 65535)) {
                        port.classList.add('error');
                        valid = false;
                    } else if (port) {
                        port.classList.remove('error');
                    }
                    // Validate header pattern
                    const header = document.getElementById('api_key_header');
                    const headerPattern = /^[A-Za-z0-9_-]+$/;
                    if (header && header.value && !headerPattern.test(header.value)) {
                        header.classList.add('error');
                        valid = false;
                    } else if (header) {
                        header.classList.remove('error');
                    }
                    // Validate providers (loop over name fields)
                    const names = form.querySelectorAll('input[name^="provider_name_"]');
                    names.forEach(function(nameInput) {
                        if (!nameInput.value.trim()) {
                            nameInput.classList.add('error');
                            valid = false;
                        } else {
                            nameInput.classList.remove('error');
                        }
                    });
                    const models = form.querySelectorAll('textarea[name^="models_"]');
                    models.forEach(function(modelInput) {
                        if (!modelInput.value.trim()) {
                            modelInput.classList.add('error');
                            valid = false;
                        } else {
                            modelInput.classList.remove('error');
                        }
                    });
                    const priorities = form.querySelectorAll('input[name^="priority_"]');
                    priorities.forEach(function(priInput) {
                        const pri = parseInt(priInput.value);
                        if (isNaN(pri) || pri < 0) {
                            priInput.classList.add('error');
                            valid = false;
                        } else {
                            priInput.classList.remove('error');
                        }
                    });
                    if (!valid) {
                        e.preventDefault();
                        alert('Please fix the errors before submitting.');
                    }
                });

                // Handle forced provider radio buttons
                form.addEventListener('change', function(e) {
                    if (e.target.name === 'forced_provider') {
                        // Uncheck all other forced checkboxes when one is selected
                        const forcedRadios = form.querySelectorAll('input[name="forced_provider"]');
                        forcedRadios.forEach(radio => {
                            if (radio !== e.target) {
                                radio.checked = false;
                            }
                        });
                    }
                    
                    // Handle enabled/disabled state
                    if (e.target.name && e.target.name.startsWith('enabled_')) {
                        const index = e.target.name.replace('enabled_', '');
                        const forcedRadio = form.querySelector(`input[name="forced_provider"][value="${document.getElementById('name-' + index).value}"]`);
                        if (forcedRadio && !e.target.checked) {
                            // If disabling a provider, also uncheck its forced radio
                            forcedRadio.checked = false;
                        }
                    }
                });
                
                // Remove error on input
                form.addEventListener('input', function(e) {
                    if (e.target.classList.contains('error')) {
                        e.target.classList.remove('error');
                    }
                });
            }
        });
    </script>
</body>
</html>
